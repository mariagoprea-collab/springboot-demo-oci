name: Build + Deploy to OCI Container Instances

on:
  push:
    branches: [main]
  workflow_dispatch:
    {}

concurrency:
  group: oci-deploy-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

defaults:
  run:
    shell: bash

env:
  # ---- OCI Auth (keep as secrets) ----
  OCI_CLI_USER: ${{ secrets.OCI_CLI_USER }}
  OCI_CLI_TENANCY: ${{ secrets.OCI_CLI_TENANCY }}
  OCI_CLI_FINGERPRINT: ${{ secrets.OCI_CLI_FINGERPRINT }}
  OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_CLI_KEY_CONTENT }}
  OCI_CLI_REGION: ${{ secrets.OCI_CLI_REGION }}

  # ---- OCIR settings ----
  OCIR_REGION_KEY: ${{ vars.OCIR_REGION_KEY }}
  IMAGE_REPO: ${{ vars.IMAGE_REPO }}

  # ---- Container Instance settings ----
  COMPARTMENT_ID: ${{ vars.COMPARTMENT_ID }}
  SUBNET_ID: ${{ vars.SUBNET_ID }}
  SHAPE: ${{ vars.SHAPE }}
  CONTAINER_INSTANCE_NAME: ${{ vars.CONTAINER_INSTANCE_NAME }}
  CONTAINER_DISPLAY_NAME: ${{ vars.CONTAINER_DISPLAY_NAME }}
  SHAPE_OCPUS: "1"
  SHAPE_MEMORY_GB: "2"

  # ---- App config ----
  DB_HOST: ${{ vars.DB_HOST }}
  DB_NAME: ${{ vars.DB_NAME }}

jobs:
  build:
    name: Build + push image to OCIR
    runs-on: ubuntu-latest
    outputs:
      image_ref: ${{ steps.meta.outputs.image_ref }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Log into OCIR
        uses: oracle-actions/login-ocir@v1.3.0
        with:
          auth_token: ${{ secrets.OCI_AUTH_TOKEN }}

      - name: Build JAR (Maven)
        run: mvn -B clean package -DskipTests

      - name: Install OCI CLI + jq (for namespace lookup)
        run: |
          set -euo pipefail
          python3 -m pip install --user "oci-cli>=3.0.0"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi

      - name: Build + push Docker image
        id: meta
        run: |
          set -euo pipefail
          NAMESPACE=$(oci os ns get | jq .data | tr -d '"')
          IMAGE_SHA="${OCIR_REGION_KEY}.ocir.io/${NAMESPACE}/${IMAGE_REPO}:${GITHUB_SHA}"
          IMAGE_LATEST="${OCIR_REGION_KEY}.ocir.io/${NAMESPACE}/${IMAGE_REPO}:latest"

          echo "Building: ${IMAGE_SHA}"
          docker build -t "${IMAGE_SHA}" -t "${IMAGE_LATEST}" .
          docker push "${IMAGE_SHA}"
          docker push "${IMAGE_LATEST}"

          echo "image_ref=${IMAGE_SHA}" >> "$GITHUB_OUTPUT"

  deploy:
    name: Deploy container instance (idempotent)
    runs-on: ubuntu-latest
    needs: [build]
    env:
      IMAGE: ${{ needs.build.outputs.image_ref }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASS: ${{ secrets.DB_PASS }}
      # NOTE: OCI container-instance "update image" has proven unreliable in this tenancy.
      # We always do blue/green replace: create new -> update LB -> delete old.
      DEPLOY_STRATEGY: replace
      BACKEND_IP_TYPE: ${{ vars.BACKEND_IP_TYPE || 'private' }}
      # Optional: configure these secrets if you want the LB update flow
      BACKEND_LB_OCID: ${{ secrets.OCI_BACKEND_LB_OCID }}
      BACKEND_SET_NAME: ${{ secrets.OCI_BACKEND_LB_BACKEND_SET_NAME }}
      BACKEND_PORT: ${{ secrets.OCI_BACKEND_LB_BACKEND_PORT }}
      LB_HEALTH_TIMEOUT_SECONDS: ${{ vars.LB_HEALTH_TIMEOUT_SECONDS || '600' }}
      LB_HEALTH_POLL_SECONDS: ${{ vars.LB_HEALTH_POLL_SECONDS || '10' }}
      CUTOVER_GRACE_SECONDS: ${{ vars.CUTOVER_GRACE_SECONDS || '0' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install OCI CLI
        run: |
          set -euo pipefail
          python3 -m pip install --user "oci-cli>=3.0.0"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          
      - name: Deploy (update or replace)
        run: |
          set -euo pipefail
          chmod +x scripts/oci/deploy_container_instance.sh scripts/oci/update_lb_backend.sh
          scripts/oci/deploy_container_instance.sh

      - name: Update backend load balancer (only on replace)
        if: ${{ env.DID_REPLACE == 'true' && env.BACKEND_LB_OCID != '' && env.BACKEND_SET_NAME != '' && env.BACKEND_PORT != '' && env.NEW_INSTANCE_IP != '' }}
        run: |
          set -euo pipefail
          scripts/oci/update_lb_backend.sh

      - name: Cleanup old instances (after LB cutover)
        if: ${{ env.DID_REPLACE == 'true' && env.OLD_INSTANCE_IDS != '' && env.BACKEND_LB_OCID != '' && env.BACKEND_SET_NAME != '' && env.BACKEND_PORT != '' && env.NEW_INSTANCE_IP != '' }}
        run: |
          set -euo pipefail
          chmod +x scripts/oci/cleanup_old_instances.sh
          scripts/oci/cleanup_old_instances.sh
